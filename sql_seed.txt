CREATE TABLE dbo.Customer (
  customer_id INT IDENTITY PRIMARY KEY,
  name NVARCHAR(200) NOT NULL,
  email NVARCHAR(200),
  phone NVARCHAR(50),
  billing_address NVARCHAR(400),
  created_at DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);

CREATE TABLE dbo.Job (
  job_id INT IDENTITY PRIMARY KEY,
  job_number NVARCHAR(50) UNIQUE NOT NULL,
  name NVARCHAR(200) NOT NULL,
  customer_id INT NOT NULL REFERENCES dbo.Customer(customer_id),
  status NVARCHAR(30) NOT NULL DEFAULT 'open',
  created_at DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);

-- Ticket table aligned to current app fields
-- App collects: jobNumber, jobName, date, customerName, technician,
-- workPerformed (text), materialList (text), labor (role + regular/OT), signature (strokes)
CREATE TABLE dbo.Ticket (
  ticket_id BIGINT IDENTITY PRIMARY KEY,
  job_number NVARCHAR(50) NOT NULL,
  job_name NVARCHAR(200) NOT NULL,
  ticket_date DATE NOT NULL,
  customer_name NVARCHAR(200) NOT NULL,
  technician NVARCHAR(200) NOT NULL,
  work_performed NVARCHAR(MAX) NOT NULL,
  material_list NVARCHAR(MAX) NULL,
  signature_json NVARCHAR(MAX) NULL,
  created_at DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);

-- Labor rows now store role + regular/OT hours only
CREATE TABLE dbo.TicketLabor (
  id BIGINT IDENTITY PRIMARY KEY,
  ticket_id BIGINT NOT NULL REFERENCES dbo.Ticket(ticket_id) ON DELETE CASCADE,
  role NVARCHAR(20) NOT NULL,
  regular_hours DECIMAL(5,2) NOT NULL CHECK (regular_hours >= 0),
  ot_hours DECIMAL(5,2) NOT NULL CHECK (ot_hours >= 0),
  CONSTRAINT CK_TicketLabor_Role CHECK (role IN (N'Foreman', N'Journeyman', N'Apprentice'))
);

-- Freeform materials text captured in Ticket.material_list; no line items table.

CREATE INDEX IX_Job_customer ON dbo.Job(customer_id);
CREATE INDEX IX_Ticket_jobnumber ON dbo.Ticket(job_number, ticket_date);
CREATE INDEX IX_Ticket_tech ON dbo.Ticket(technician, ticket_date);
CREATE INDEX IX_Labor_ticket ON dbo.TicketLabor(ticket_id, role);

INSERT dbo.Customer(name,email)
VALUES (N'Acme Builders',N'ap@acme.com'),
       (N'Delta GC',N'ap@deltagc.com');

INSERT dbo.Job(job_number,name,customer_id)
VALUES (N'WEC-24115',N'Midtown Office Fit-Out',1),
       (N'WEC-24116',N'Airport Concourse B',2);

-- Sample tickets that mirror the app's fields
INSERT dbo.Ticket(job_number, job_name, ticket_date, customer_name, technician, work_performed, material_list, signature_json)
VALUES
(N'WEC-24115', N'Midtown Office Fit-Out', CAST(SYSDATETIME() AS DATE), N'Acme Builders', N'Jane Smith',
 N'Replaced failed ballast and rewired fixture circuit. Verified operation.',
 N'2x LED Ballast, 50ft 12/2 MC',
 N'[]'),
(N'WEC-24116', N'Airport Concourse B', CAST(SYSDATETIME() AS DATE), N'Delta GC', N'John Doe',
 N'Troubleshot GFCI trip on panel B. Tightened lugs and replaced breaker.',
 N'1x 20A GFCI, Assorted wirenuts',
 N'[]');

INSERT dbo.TicketLabor(ticket_id, role, regular_hours, ot_hours)
SELECT t.ticket_id, v.role, v.regular_hours, v.ot_hours
FROM dbo.Ticket t
CROSS APPLY (VALUES
  (N'Foreman', 1.0, 0.0),
  (N'Journeyman', 2.0, 0.5)
) AS v(role, regular_hours, ot_hours)
WHERE t.job_number = N'WEC-24115';
